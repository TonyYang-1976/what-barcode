<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ê¢ùÁ¢ºÊ™¢Ê†∏ What barcode (v10.34)</title>
    <script src="https://unpkg.com/bwip-js@4.2.0/dist/bwip-js-min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        /* ÂºïÂÖ• Google Fonts: Space Mono (È°û OCR-B) */
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Roboto:wght@300;500&display=swap');

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans TC", sans-serif; 
            background-color: #f0f2f5; margin: 0; padding: 20px; 
        }
        
        .main-container { 
            max-width: 850px; margin: 0 auto; background-color: white; 
            padding: 40px; border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
            border-top: 5px solid #0055AA; 
        }

        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #eaeff2; padding-bottom: 20px; }
        .main-title { 
            font-size: 32px; font-weight: 900; 
            background: linear-gradient(135deg, #002B5B 0%, #0055AA 100%); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
        }
        .sub-title { font-family: 'Roboto', sans-serif; font-size: 22px; font-weight: 300; color: #5f6c7b; }
        
        .status-badge { padding: 8px 16px; border-radius: 30px; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .status-online { background-color: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; }
        .status-offline { background-color: #fffbeb; color: #d97706; border: 1px solid #fde68a; }
        .status-error { background-color: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: currentColor; box-shadow: 0 0 5px currentColor; }

        .input-area { position: sticky; top: 0; background: white; z-index: 100; padding-bottom: 20px; margin-bottom: 10px; display: flex; gap: 10px; }
        input[type="text"].main-input { 
            flex: 1; padding: 18px; font-size: 28px; text-align: center; 
            border: 2px solid #e2e8f0; border-radius: 12px; outline: none; font-weight: bold; letter-spacing: 3px; background: #f8fafc;
        }
        input[type="text"].main-input:focus { border-color: #0055AA; background: #fff; }
        .camera-btn { padding: 0 25px; font-size: 24px; cursor: pointer; background-color: #0055AA; color: white; border: none; border-radius: 12px; }
        .camera-btn.active { background-color: #dc2626; }

        #reader-container { width: 100%; margin-bottom: 20px; display: none; border-radius: 12px; overflow: hidden; border: 2px solid #e2e8f0; background: #000; }
        #reader { width: 100%; }

        .results-grid { display: grid; grid-template-columns: 1fr; gap: 25px; }
        .barcode-card { border-radius: 12px; padding: 30px; background: #fff; border: 1px solid #e2e8f0; display: flex; flex-direction: column; align-items: center; }
        .card-best-match { border: 2px solid #28a745; background: linear-gradient(to bottom, #f0fff4 0%, #ffffff 100%); transform: scale(1.01); z-index: 10; }
        .card-header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; }
        
        /* v10.34: Checkbox Group Styling */
        .card-options-group { display: flex; flex-direction: column; gap: 6px; align-items: flex-end; }
        .card-options { font-size: 13px; color: #475569; display: flex; align-items: center; gap: 6px; background: #f1f5f9; padding: 6px 10px; border-radius: 6px; border: 1px solid #cbd5e1; }
        .card-options label { cursor: pointer; display: flex; align-items: center; gap: 4px; user-select: none; }
        .card-options input { accent-color: #0055AA; width: 16px; height: 16px; }

        canvas { display: block; max-width: 100%; height: auto !important; image-rendering: pixelated; background-color: white; border-radius: 8px; border: 1px solid #f1f5f9; margin-bottom: 10px; }
        
        .btn-group { display: flex; gap: 12px; width: 100%; margin-top: 10px; }
        button { flex: 1; padding: 12px; font-size: 14px; font-weight: 600; cursor: pointer; background-color: #fff; border: 1px solid #cbd5e1; border-radius: 8px; color: #475569; display: flex; align-items: center; justify-content: center; gap: 6px; }
        button:hover { background-color: #f0f9ff; border-color: #0055AA; color: #0055AA; }

        .edit-panel { width: 100%; display: none; flex-direction: column; gap: 12px; background: #f8fafc; padding: 20px; border-radius: 10px; border: 1px solid #cbd5e1; margin-bottom: 20px; }
        .edit-input { width: 100%; padding: 10px; font-size: 18px; border: 2px solid #0055AA; border-radius: 6px; text-align: center; font-weight: bold; }
        .btn-save { background-color: #0055AA; color: white !important; border: none; }

        .density-tag { font-size: 12px; font-weight: bold; padding: 2px 8px; border-radius: 4px; margin-left: 8px; display: inline-block; vertical-align: middle; }
        .density-high { background-color: #e0f7fa; color: #006064; border: 1px solid #b2ebf2; }
        .density-low { background-color: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="header-row">
        <div class="title-group">
            <div class="main-title">Ê¢ùÁ¢ºÊ™¢Ê†∏</div>
            <div class="sub-title">What barcode (v10.34)</div>
        </div>
        <div id="statusBadge" class="status-badge status-offline"><span class="status-dot"></span> <span id="statusText">Ê™¢Êü•‰∏≠...</span></div>
    </div>

    <div id="reader-container"><div id="reader"></div></div>

    <div class="input-area">
        <input type="text" id="inputData" class="main-input" placeholder="Ë´ãÊéÉÊèèÊ¢ùÁ¢º" autofocus>
        <button id="cameraBtn" class="camera-btn" onclick="toggleCamera()">üì∑</button>
    </div>

    <div id="resultsGrid" class="results-grid"><div class="empty-state" style="text-align:center; color:#94a3b8; margin-top:30px;">Á≠âÂæÖËº∏ÂÖ•...</div></div>
</div>

<script>
    const inputData = document.getElementById('inputData');
    const resultsGrid = document.getElementById('resultsGrid');
    const statusBadge = document.getElementById('statusBadge');
    let debounceTimer, html5QrCode, isCameraRunning = false;

    window.onload = updateSystemStatus;
    function updateSystemStatus() {
        if (typeof bwipjs === 'undefined') {
            statusBadge.className = 'status-badge status-error';
            document.getElementById('statusText').textContent = "Ê†∏ÂøÉËºâÂÖ•Â§±Êïó";
            return;
        }
        statusBadge.className = navigator.onLine ? 'status-badge status-online' : 'status-badge status-offline';
        document.getElementById('statusText').textContent = navigator.onLine ? "ÈÄ£Á∑öÊ≠£Â∏∏" : "Èõ¢Á∑öÊ®°Âºè";
        inputData.focus();
    }

    function toggleCamera() {
        const container = document.getElementById('reader-container');
        const btn = document.getElementById('cameraBtn');
        if (isCameraRunning) {
            html5QrCode.stop().then(() => { container.style.display = 'none'; btn.classList.remove('active'); btn.innerHTML = 'üì∑'; isCameraRunning = false; });
        } else {
            container.style.display = 'block'; btn.classList.add('active'); btn.innerHTML = '‚èπ';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 150 } }, 
                (txt) => { inputData.value = txt; toggleCamera(); analyzeAndRender(txt.toUpperCase()); }, () => {});
            isCameraRunning = true;
        }
    }

    inputData.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => { analyzeAndRender(inputData.value.trim().toUpperCase()); }, 300);
    });

    function checkEAN8Checksum(text) {
        if (!/^\d{8}$/.test(text)) return false;
        let sum = 0; for (let i = 0; i < 7; i++) sum += parseInt(text[i]) * (i % 2 === 0 ? 3 : 1);
        return ((10 - (sum % 10)) % 10) === parseInt(text[7]);
    }

    function getCandidates(rawText) {
        let isGS1Prefixed = rawText.startsWith(']C1') || rawText.startsWith(']c1');
        let isCode39Prefixed = rawText.startsWith(']A0') || rawText.startsWith(']a0');
        let cleanText = rawText.replace(/[-\s\*\(\)<>\]A0C1c1a0]/g, '');
        let list = [];

        if (/^[A-D]?[0-9\-\$\:\/\.\+]+[A-D]?$/.test(rawText)) list.push({ id: 'rationalizedCodabar', name: 'Codabar (NW-7)', desc: 'ÂúñÊõ∏È§®/Ë°ÄÂ∫´', score: 120 });
        if (isCode39Prefixed || /^[0-9A-Z \-\.\$\/\+\%]+$/.test(rawText)) list.push({ id: 'code39', name: 'Code 39', desc: 'Â∑•Ê•≠Ê®ôÊ∫ñ', score: 130 });
        if (isGS1Prefixed || /^01\d{14}/.test(cleanText)) list.push({ id: 'gs1-128', name: 'GS1-128', desc: 'Áâ©ÊµÅÊ®ôÊ∫ñ', score: 250 });
        if (/^[\x00-\x7F]+$/.test(rawText)) list.push({ id: 'code128', name: 'Code 128', desc: 'ÈÄöÁî®Ê®ôÊ∫ñ', score: 100 });

        if (/^\d+$/.test(cleanText)) {
            let len = cleanText.length;
            if (len === 8) list.push({ id: 'ean8', name: 'EAN-8', desc: 'Èõ∂ÂîÆÁü≠Á¢º', score: 250 });
            else if (len === 12) list.push({ id: 'upca', name: 'UPC-A', desc: 'ÁæéÂä†Ê®ôÊ∫ñ', score: 250 });
            else if (len === 13) list.push({ id: 'ean13', name: 'EAN-13', desc: 'Èõ∂ÂîÆÊ®ôÊ∫ñ', score: 250 });
            else if (len === 14) list.push({ id: 'itf14', name: 'ITF-14', desc: 'Â§ñÁÆ±Ê¢ùÁ¢º', score: 250 });
        }
        return list.sort((a, b) => b.score - a.score);
    }

    function analyzeAndRender(text) {
        resultsGrid.innerHTML = "";
        if (!text) { resultsGrid.innerHTML = '<div class="empty-state" style="text-align:center;">Á≠âÂæÖËº∏ÂÖ•...</div>'; return; }

        let cleanText = text.replace(/[-\s\*\(\)<>\]A0C1c1a0]/g, '');
        let candidates = getCandidates(text);

        candidates.forEach((cand, index) => {
            let cardStyle = index === 0 ? 'card-best-match' : 'card-alternative';
            // v10.34: Pass cleanText specifically for EAN/UPC to avoid noise
            createBarcodeCard(text, cleanText, cand, cardStyle);
        });
    }

    function createBarcodeCard(rawText, cleanText, cand, styleClass) {
        const card = document.createElement('div'); card.className = `barcode-card ${styleClass}`;
        
        let isRetail = ['ean13', 'upca', 'ean8', 'isbn', 'upce'].includes(cand.id);
        let hasLeftMark = rawText.includes('<');
        let hasRightMark = rawText.includes('>');
        
        let toggleHTML = '';
        if (isRetail) {
            let leftCheck = hasLeftMark ? 'checked' : '';
            let rightCheck = hasRightMark ? 'checked' : '';
            toggleHTML = `
                <div class="card-options-group">
                    <div class="card-options"><label><input type="checkbox" class="mark-left-check" ${leftCheck} onchange="updateCanvas(this, '${cand.id}', '${cleanText}')"> È°ØÁ§∫Â∑¶ÂÅ¥ <</label></div>
                    <div class="card-options"><label><input type="checkbox" class="mark-right-check" ${rightCheck} onchange="updateCanvas(this, '${cand.id}', '${cleanText}')"> È°ØÁ§∫Âè≥ÂÅ¥ ></label></div>
                </div>`;
        } else if (cand.id === 'code39') {
            toggleHTML = `<div class="card-options"><label><input type="checkbox" class="show-symbols-check" checked onchange="updateCanvas(this, '${cand.id}', '${rawText}')"> È°ØÁ§∫Ëµ∑Ê≠¢Á¨¶Ëôü</label></div>`;
        }

        let densityBadge = cand.id === 'code128' ? '<span class="density-tag density-high">‚ö° È´òÂØÜÂ∫¶</span>' : (cand.id === 'code39' ? '<span class="density-tag density-low">üìè ÂØ¨Áâà</span>' : '');

        card.innerHTML = `
            <div class="card-header">
                <div><span class="format-name">${cand.name}</span>${densityBadge}<div class="format-tag">${cand.desc}</div></div>
                ${toggleHTML}
            </div>
            <div class="edit-panel"><input type="text" class="edit-input" value="${rawText}"><div class="edit-actions"><button class="btn-save" onclick="quickFixCard(this, '${cand.id}')">‰øÆÊîπ</button><button onclick="toggleEditMode(this)">ÂèñÊ∂à</button></div></div>
            <canvas></canvas>
            <div class="btn-group">
                <button onclick="toggleEditMode(this)">‚úèÔ∏è ‰øÆÊîπ</button>
                <button onclick="downloadPNG(this)">‚¨á PNG</button>
                <button onclick="downloadSVGFromCard(this)">‚¨á SVG</button>
            </div>
        `;
        
        const canvas = card.querySelector('canvas');
        resultsGrid.appendChild(card);
        // Initial Draw
        drawBarcode(canvas, cand.id, isRetail ? cleanText : rawText, isRetail ? {left: hasLeftMark, right: hasRightMark} : {legacy: true});
    }

    window.updateCanvas = function(cb, formatId, text) {
        const card = cb.closest('.barcode-card');
        const canvas = card.querySelector('canvas');
        const leftCheck = card.querySelector('.mark-left-check');
        const rightCheck = card.querySelector('.mark-right-check');
        const legacyCheck = card.querySelector('.show-symbols-check');

        let flags = {};
        if (leftCheck) flags.left = leftCheck.checked;
        if (rightCheck) flags.right = rightCheck.checked;
        if (legacyCheck) flags.legacy = legacyCheck.checked;

        drawBarcode(canvas, formatId, text, flags);
    }

    window.quickFixCard = function(btn, formatId) {
        const card = btn.closest('.barcode-card');
        const val = card.querySelector('.edit-input').value;
        card.querySelector('.edit-panel').style.display = 'none';
        updateCanvas(btn, formatId, val); // Re-trigger update
    }

    function toggleEditMode(btn) {
        const card = btn.closest('.barcode-card');
        const panel = card.querySelector('.edit-panel');
        const canvas = card.querySelector('canvas');
        panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
        if (panel.style.display === 'flex') canvas.style.display = 'none'; else canvas.style.display = 'block';
    }

    // v10.34: The Core Logic - Three-Zone Composition
    function drawBarcode(canvas, formatId, text, flags) {
        try {
            let scale = 3;
            // Zone 1: Pure Barcode Area Settings
            let drawOpts = {
                bcid: formatId,
                text: text,
                scale: scale,
                includetext: true,       // Native text enabled
                textxalign: 'center',
                backgroundcolor: 'ffffff',
            };

            let isRetail = ['ean13', 'upca', 'ean8', 'isbn', 'upce'].includes(formatId);

            if (isRetail) {
                // v10.34 CRITICAL FIX: Force Separation
                drawOpts.barheight = 20;    // Hard limit on bar height
                drawOpts.textyoffset = 5;   // Physical gap between bar bottom and text top
                drawOpts.textsize = 13;     // Consistent text size
                
                // Native drawing handles guard bars extending into the gap automatically
                // We just need to ensure ample padding on sides for our marks
                drawOpts.paddingwidth = 15; 
                drawOpts.paddingheight = 2;
            } else {
                // Industrial formats
                drawOpts.height = 25;
                if (formatId === 'code39' && !flags.legacy) drawOpts.text = text.replace(/\*/g, '');
                drawOpts.alttext = drawOpts.text; // Use custom text rendering for non-retail
            }

            // Save for download
            canvas.dataset.drawOpts = JSON.stringify(drawOpts);
            canvas.dataset.flags = JSON.stringify(flags);

            // Draw Layer 1 & 2 (Bars + Native Text)
            bwipjs.toCanvas(canvas, drawOpts);

            // Draw Layer 3 (Indicators) - ONLY for Retail
            if (isRetail && (flags.left || flags.right)) {
                injectLayer3(canvas, scale, flags.left, flags.right);
            }

        } catch (e) { console.error(e); }
    }

    // Layer 3 Injection
    function injectLayer3(canvas, scale, showLeft, showRight) {
        const ctx = canvas.getContext('2d');
        ctx.save();
        
        let fontSize = 14 * scale; // Slightly larger for symbols
        // Force monospace to match OCR-B vibe
        ctx.font = `bold ${fontSize}px "Space Mono", Consolas, monospace`; 
        ctx.fillStyle = '#000000';
        
        // Alignment Logic:
        // Y: Align with the text baseline. 
        // In bwip-js with textyoffset=5, the text baseline is roughly 4-5 units from bottom.
        // We set Y to canvas.height - (4 * scale) to align perfectly.
        ctx.textBaseline = 'alphabetic';
        let yPos = canvas.height - (4 * scale); 

        // X: Anchor to the padding edge
        let padPx = 15 * scale; // Matches paddingwidth in drawOpts

        if (showLeft) {
            ctx.textAlign = 'right';
            // Draw slightly inside the padding area (close to the first bar)
            ctx.fillText('<', padPx - (2 * scale), yPos);
        }
        if (showRight) {
            ctx.textAlign = 'left';
            // Draw slightly inside the right padding area
            ctx.fillText('>', canvas.width - padPx + (2 * scale), yPos);
        }
        ctx.restore();
    }

    window.downloadPNG = function(btn) {
        const canvas = btn.closest('.barcode-card').querySelector('canvas');
        let opts = JSON.parse(canvas.dataset.drawOpts);
        let flags = JSON.parse(canvas.dataset.flags || '{}');
        
        // High Res Download
        let scale = 6; // Double resolution
        opts.scale = scale;
        
        const c = document.createElement('canvas');
        try {
            bwipjs.toCanvas(c, opts);
            // Re-inject markings if needed
            let isRetail = ['ean13', 'upca', 'ean8', 'isbn', 'upce'].includes(opts.bcid);
            if (isRetail && (flags.left || flags.right)) {
                injectLayer3(c, scale, flags.left, flags.right);
            }
            
            const a = document.createElement('a');
            a.href = c.toDataURL('image/png');
            a.download = `Barcode_${opts.text}.png`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        } catch(e) {}
    }

    // SVG Injection for Download
    window.downloadSVGFromCard = function(btn) {
        const canvas = btn.closest('.barcode-card').querySelector('canvas');
        let opts = JSON.parse(canvas.dataset.drawOpts);
        let flags = JSON.parse(canvas.dataset.flags || '{}');
        
        let svg = bwipjs.toSVG(opts);
        
        // Inject SVG text elements if retail
        let isRetail = ['ean13', 'upca', 'ean8', 'isbn', 'upce'].includes(opts.bcid);
        if (isRetail && (flags.left || flags.right)) {
            // Need height/width from SVG string
            let match = svg.match(/viewBox="0 0 (\d+) (\d+)"/);
            if (match) {
                let w = parseInt(match[1]);
                let h = parseInt(match[2]);
                // Align Y based on unscaled units (approx height - 4)
                let y = h - 4;
                let style = 'font-family: "Space Mono", Consolas, monospace; font-weight: bold; font-size: 13px; fill: #000000;';
                let extra = '';
                if (flags.left) extra += `<text x="12" y="${y}" text-anchor="end" style="${style}">&lt;</text>`;
                if (flags.right) extra += `<text x="${w-12}" y="${y}" text-anchor="start" style="${style}">&gt;</text>`;
                svg = svg.replace('</svg>', extra + '</svg>');
            }
        }
        
        const b = new Blob([svg], {type: "image/svg+xml;charset=utf-8"});
        const u = URL.createObjectURL(b), a = document.createElement('a');
        a.href = u; a.download = `Barcode_${opts.text}.svg`; a.click();
    }
</script>
</body>
</html>
